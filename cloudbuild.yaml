# Orion System v8.2 - CI/CD Pipeline (FORCED DEPLOYMENT - FINAL)

steps:
# --- orion-sec-fetcher ---
- name: 'gcr.io/cloud-builders/docker'
  dir: 'microservices/orion-sec-fetcher'
  args: [ 'build', '-t', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-sec-fetcher:$COMMIT_SHA', '.' ]
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-sec-fetcher:$COMMIT_SHA' ]
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args: [ 'run', 'deploy', 'orion-sec-fetcher', '--image', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-sec-fetcher:$COMMIT_SHA', '--region', 'asia-northeast1', '--service-account', 'orion-service-account@$PROJECT_ID.iam.gserviceaccount.com', '--allow-unauthenticated' ]

# --- orion-insight-wrangler ---
- name: 'gcr.io/cloud-builders/docker'
  dir: 'orion-insight-wrangler'
  args: [ 'build', '-t', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-insight-wrangler:$COMMIT_SHA', '.' ]
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-insight-wrangler:$COMMIT_SHA' ]
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args: [ 'run', 'deploy', 'orion-insight-wrangler', '--image', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-insight-wrangler:$COMMIT_SHA', '--region', 'asia-northeast1', '--service-account', 'orion-service-account@$PROJECT_ID.iam.gserviceaccount.com', '--allow-unauthenticated' ]

# --- (This pattern is repeated for all containerized services) ... ---

# --- Cloud Functions ---
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args: [ 'functions', 'deploy', 'zero-cost-filter', '--gen2', '--runtime=python312', '--source=./microservices/zero-cost-filter', '--entry-point=pre_filter_url', '--trigger-topic=raw-urls-ingest', '--region=asia-northeast1', '--service-account=orion-service-account@$PROJECT_ID.iam.gserviceaccount.com' ]
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  dir: 'microservices/alpha-loop-launcher'
  entrypoint: gcloud
  args: [ 'functions', 'deploy', 'trigger-alpha-loop-func', '--gen2', '--runtime=python312', '--source=.', '--entry-point=main', '--trigger-http', '--allow-unauthenticated', '--region=asia-northeast1', '--service-account=orion-service-account@$PROJECT_ID.iam.gserviceaccount.com' ]

options:
  logging: CLOUD_LOGGING_ONLY
  diskSizeGb: 200