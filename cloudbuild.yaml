# Orion System - Hardened CI/CD Pipeline (Final Path Correction)
steps:
  # --- orion-sec-fetcher ---
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'microservices/orion-sec-fetcher'
    args: ['build', '-t', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-sec-fetcher:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-sec-fetcher:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: ['run', 'deploy', 'orion-sec-fetcher', '--image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-sec-fetcher:$COMMIT_SHA', '--region=asia-northeast1', '--service-account=orion-sec-fetcher-sa@$PROJECT_ID.iam.gserviceaccount.com', '--no-allow-unauthenticated']

  # --- orion-insight-wrangler ---
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'orion-services/orion-insight-wrangler' # Corrected Path
    args: ['build', '-t', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-insight-wrangler:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-insight-wrangler:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: ['run', 'deploy', 'orion-insight-wrangler', '--image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/orion-images/orion-insight-wrangler:$COMMIT_SHA', '--region=asia-northeast1', '--service-account=orion-insight-wrangler-sa@$PROJECT_ID.iam.gserviceaccount.com', '--no-allow-unauthenticated']

  # --- (Other services would follow the same corrected pattern) ... ---

  # --- Cloud Functions ---
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    dir: 'microservices/zero-cost-filter'
    entrypoint: gcloud
    args: ['functions', 'deploy', 'zero-cost-filter', '--gen2', '--runtime=python312', '--source=.', '--entry-point=pre_filter_url', '--trigger-topic=raw-urls-ingest', '--region=asia-northeast1', '--service-account=zero-cost-filter-sa@$PROJECT_ID.iam.gserviceaccount.com']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    dir: 'microservices/alpha-loop-launcher'
    entrypoint: gcloud
    args: ['functions', 'deploy', 'trigger-alpha-loop-func', '--gen2', '--runtime=python312', '--source=.', '--entry-point=launch_alpha_loop_job_v2', '--trigger-http', '--no-allow-unauthenticated', '--region=asia-northeast1', '--service-account=trigger-alpha-loop-func-sa@$PROJECT_ID.iam.gserviceaccount.com']

options:
  logging: CLOUD_LOGGING_ONLY
  diskSizeGb: 200
